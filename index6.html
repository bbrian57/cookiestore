<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã€Šéœ“è™¹ç”Ÿå­˜è€…ï¼šæ–¹å¡Šåæ“Šã€‹</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --text:#e9ecff; --muted:#9aa3c7; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: radial-gradient(1200px 700px at 50% 30%, #18224a 0%, var(--bg) 55%, #070a14 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "Segoe UI", Arial;
      color:var(--text);
    }
    .wrap{ width:min(920px, 92vw); display:grid; gap:14px; }
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background: rgba(18,26,51,.75); border:1px solid rgba(255,255,255,.10);
      padding:12px 14px; border-radius:14px; box-shadow: 0 16px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .title{ display:flex; flex-direction:column; gap:4px; }
    .title b{ font-size:16px; letter-spacing:.5px; }
    .title span{ font-size:12px; color:var(--muted); }
    .hud{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:flex; gap:8px; align-items:baseline;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;
    }
    .pill b{ font-size:14px; }
    .btn{
      cursor:pointer; user-select:none;
      padding:9px 12px; border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      font-weight:700; font-size:12px;
      transition: transform .08s ease, filter .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    canvas{
      width:100%; aspect-ratio: 16/9;
      background: rgba(5,7,14,.65);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      display:block;
    }
    .hint{
      color:var(--muted); font-size:12px; line-height:1.6;
      background: rgba(18,26,51,.55);
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px; border-radius:14px;
    }
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background: rgba(0,0,0,.55);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .card{
      width:min(560px, 92vw);
      background: rgba(18,26,51,.88);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow: 0 26px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .card h2{ margin:0 0 8px; font-size:18px; }
    .card p{ margin:6px 0; color:var(--muted); font-size:13px; line-height:1.7; }
    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <b>èº²é¿æ–¹å¡Šï¼ˆå¯å°„æ“Šï¼‰</b>
        <span>WASD/æ–¹å‘éµç§»å‹•ï½œSpace/é»æ“Šå°„æ“Šï½œèº²é–‹æ•µäººï½œR é‡æ–°é–‹å§‹</span>
      </div>
      <div class="hud">
        <div class="pill">æ™‚é–“ <b id="t">30.0</b>s</div>
        <div class="pill">åˆ†æ•¸ <b id="score">0</b></div>
        <div class="pill">å°„æ“Šå†·å» <b id="cd">0%</b></div>
        <button class="btn" id="restart">é‡æ–°é–‹å§‹ (R)</button>
      </div>
    </div>

    <canvas id="game" width="960" height="540"></canvas>

    <div class="hint">
      æ”»æ“Šï¼š<b>ç©ºç™½éµ Space</b> æœƒæœã€Œæœ€å¾Œç§»å‹•æ–¹å‘ã€å°„æ“Šï¼›ä¹Ÿå¯ç”¨ <b>æ»‘é¼ é»æ“Š</b> æœæ»‘é¼ æ–¹å‘å°„æ“Šã€‚<br>
      ç›®æ¨™ï¼šæ’åˆ° 0 ç§’å°±é€šé—œ ğŸ‰ï¼ˆæ•µäººæœƒè¶Šä¾†è¶Šå¤šã€è¶Šä¾†è¶Šå¿«ï¼‰
    </div>
  </div>

  <div class="overlay show" id="overlay">
    <div class="card">
      <h2>ç©æ³•èªªæ˜</h2>
      <p>ä½ æ˜¯ç¶ è‰²æ–¹å¡Šã€‚ç”¨ <b>WASD / æ–¹å‘éµ</b>ç§»å‹•ï¼Œé¿å…è¢«ç´…è‰²æ•µäººæ’åˆ°ã€‚</p>
      <p>æ”»æ“Šæ–¹å¼ï¼šæŒ‰ <b>Space</b>ï¼ˆæœæœ€å¾Œç§»å‹•æ–¹å‘å°„æ“Šï¼‰æˆ– <b>æ»‘é¼ å·¦éµ</b>ï¼ˆæœæ»‘é¼ æ–¹å‘å°„æ“Šï¼‰ã€‚å­å½ˆå‘½ä¸­å¯æ¶ˆæ»…æ•µäººä¸¦åŠ åˆ†ã€‚</p>
      <p>æ¯éš”ä¸€æ®µæ™‚é–“æœƒæ–°å¢æ•µäººï¼Œæ’è¶Šä¹…åˆ†æ•¸è¶Šé«˜ã€‚</p>
      <div class="row">
        <button class="btn" id="startBtn">é–‹å§‹éŠæˆ²</button>
        <button class="btn" id="closeBtn">å…ˆé—œé–‰èªªæ˜</button>
      </div>
    </div>
  </div>

  <script>
    // ======= å·¥å…· =======
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const rand  = (a, b) => a + Math.random() * (b - a);
    const dist2 = (ax, ay, bx, by) => (ax - bx) ** 2 + (ay - by) ** 2;

    // ======= Canvas =======
    const cvs = document.getElementById("game");
    const ctx = cvs.getContext("2d");

    // HUD
    const tEl  = document.getElementById("t");
    const sEl  = document.getElementById("score");
    const cdEl = document.getElementById("cd");
    const overlay = document.getElementById("overlay");

    // Buttons
    document.getElementById("restart").addEventListener("click", () => reset(true));
    document.getElementById("startBtn").addEventListener("click", () => { overlay.classList.remove("show"); start(); });
    document.getElementById("closeBtn").addEventListener("click", () => { overlay.classList.remove("show"); });

    // ======= éŠæˆ²ç‹€æ…‹ =======
    const W = cvs.width, H = cvs.height;

    const player = {
      x: W * 0.5, y: H * 0.5,
      r: 12,
      vx: 0, vy: 0,
      speed: 260,      // px/s
      dirX: 1, dirY: 0 // é¢å‘ï¼ˆæœ€å¾Œç§»å‹•æ–¹å‘ï¼‰
    };

    let enemies = [];
    let bullets = [];
    let particles = [];
    let keys = new Set();

    let running = false;
    let last = 0;
    let timeLeft = 30.0;
    let score = 0;

    // é›£åº¦ï¼šæ¯ n ç§’åŠ ä¸€éš»
    let spawnTimer = 0;
    const spawnEvery = 4.0;

    // å°„æ“Š
    let shootCD = 0;
    const shootCDMax = 0.18; // ç§’ï¼ˆè¶Šå°è¶Šå¿«ï¼‰
    const bulletSpeed = 560;

    // ======= ç”Ÿæˆ =======
    function spawnEnemy() {
      const side = Math.floor(rand(0, 4)); // 0ä¸Š 1å³ 2ä¸‹ 3å·¦
      let x, y;
      if (side === 0) { x = rand(30, W - 30); y = -20; }
      if (side === 1) { x = W + 20; y = rand(30, H - 30); }
      if (side === 2) { x = rand(30, W - 30); y = H + 20; }
      if (side === 3) { x = -20; y = rand(30, H - 30); }

      const r = rand(10, 16);
      const sp = rand(90, 150) + (30 - timeLeft) * 2.2; // è¶Šå¾Œé¢è¶Šå¿«
      enemies.push({ x, y, r, sp, wob: rand(0, Math.PI * 2) });
    }

    function burst(x, y, n = 10) {
      for (let i = 0; i < n; i++) {
        const a = rand(0, Math.PI * 2);
        const sp = rand(80, 260);
        particles.push({
          x, y,
          vx: Math.cos(a) * sp,
          vy: Math.sin(a) * sp,
          life: rand(0.18, 0.35),
          r: rand(1.5, 3.2)
        });
      }
    }

    function shoot(dirX, dirY) {
      if (shootCD > 0) return;
      const len = Math.hypot(dirX, dirY) || 1;
      const nx = dirX / len, ny = dirY / len;

      const muzzleDist = player.r + 10;
      const bx = player.x + nx * muzzleDist;
      const by = player.y + ny * muzzleDist;

      bullets.push({
        x: bx, y: by,
        vx: nx * bulletSpeed,
        vy: ny * bulletSpeed,
        r: 4,
        life: 0.9
      });

      shootCD = shootCDMax;
      burst(bx, by, 6);
    }

    // ======= æ§åˆ¶ =======
    function keyName(e) {
      const k = e.key.toLowerCase();
      return k;
    }

    window.addEventListener("keydown", (e) => {
      const k = keyName(e);
      // é˜²æ­¢æ–¹å‘éµ/ç©ºç™½æ²å‹•
      if (["arrowup","arrowdown","arrowleft","arrowright","w","a","s","d","r"," "].includes(k) || k.startsWith("arrow")) {
        e.preventDefault();
      }

      if (k === "r") { reset(true); start(); return; }
      if (k === " " || k === "spacebar") { // Space
        // ç«‹åˆ»å°„æ“Šï¼šæœæœ€å¾Œç§»å‹•æ–¹å‘
        shoot(player.dirX, player.dirY);
        return;
      }

      keys.add(k);
      if (!running && !overlay.classList.contains("show")) start();
    });

    window.addEventListener("keyup", (e) => keys.delete(keyName(e)));

    // æ»‘é¼ é»æ“Šï¼šæœæ»‘é¼ æ–¹å‘å°„æ“Š
    cvs.addEventListener("mousedown", (e) => {
      if (overlay.classList.contains("show")) return;
      const rect = cvs.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (W / rect.width);
      const my = (e.clientY - rect.top)  * (H / rect.height);
      shoot(mx - player.x, my - player.y);
      if (!running) start();
    });

    // ======= ä¸»æµç¨‹ =======
    function reset(hideOverlay = false) {
      player.x = W * 0.5; player.y = H * 0.5;
      player.vx = 0; player.vy = 0;
      player.dirX = 1; player.dirY = 0;

      enemies = [];
      bullets = [];
      particles = [];
      for (let i = 0; i < 3; i++) spawnEnemy();

      timeLeft = 30.0;
      score = 0;
      spawnTimer = 0;
      shootCD = 0;

      tEl.textContent = timeLeft.toFixed(1);
      sEl.textContent = Math.floor(score).toString();
      cdEl.textContent = "0%";

      running = false;
      last = 0;

      if (hideOverlay) overlay.classList.remove("show");
      draw(0);
    }

    function start() {
      if (running) return;
      running = true;
      last = performance.now();
      requestAnimationFrame(loop);
    }

    function end(msg = "ä½ è¢«æ’åˆ°äº†ï¼") {
      running = false;
      overlay.querySelector("h2").textContent = "éŠæˆ²çµæŸ";
      overlay.querySelectorAll("p")[0].innerHTML = `${msg} åˆ†æ•¸ï¼š<b>${Math.floor(score)}</b>`;
      overlay.querySelectorAll("p")[1].innerHTML = `æŒ‰ <b>R</b> æˆ–é»ã€Œé‡æ–°é–‹å§‹ã€å†ç©ä¸€æ¬¡ã€‚`;
      overlay.classList.add("show");
    }

    function loop(now) {
      if (!running) return;
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      update(dt);
      draw(now);

      requestAnimationFrame(loop);
    }

    function update(dt) {
      // ===== ç©å®¶è¼¸å…¥ =====
      let ix = 0, iy = 0;
      if (keys.has("arrowleft") || keys.has("a")) ix -= 1;
      if (keys.has("arrowright") || keys.has("d")) ix += 1;
      if (keys.has("arrowup") || keys.has("w")) iy -= 1;
      if (keys.has("arrowdown") || keys.has("s")) iy += 1;

      // æ­£è¦åŒ–æ–œå‘
      if (ix !== 0 || iy !== 0) {
        const len = Math.hypot(ix, iy);
        ix /= len; iy /= len;
        // æ›´æ–°é¢å‘
        player.dirX = ix;
        player.dirY = iy;
      }

      player.vx = ix * player.speed;
      player.vy = iy * player.speed;

      player.x = clamp(player.x + player.vx * dt, player.r, W - player.r);
      player.y = clamp(player.y + player.vy * dt, player.r, H - player.r);

      // ===== å°„æ“Šå†·å» =====
      shootCD = Math.max(0, shootCD - dt);
      const cdPct = Math.round((shootCD / shootCDMax) * 100);
      cdEl.textContent = `${cdPct}%`;

      // ===== å­å½ˆæ›´æ–° =====
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.x += b.vx * dt;
        b.y += b.vy * dt;
        b.life -= dt;

        // å‡ºç•Œæˆ–å£½å‘½åˆ°
        if (b.life <= 0 || b.x < -30 || b.x > W + 30 || b.y < -30 || b.y > H + 30) {
          bullets.splice(i, 1);
          continue;
        }

        // å­å½ˆæ’æ•µäºº
        for (let j = enemies.length - 1; j >= 0; j--) {
          const en = enemies[j];
          const rr = (b.r + en.r);
          if (dist2(b.x, b.y, en.x, en.y) <= rr * rr) {
            // æ“Šæ®º
            enemies.splice(j, 1);
            bullets.splice(i, 1);
            score += 25; // æ“Šæ®ºåŠ åˆ†
            burst(en.x, en.y, 14);
            break;
          }
        }
      }

      // ===== ç²’å­æ›´æ–° =====
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vx *= (1 - 6 * dt);
        p.vy *= (1 - 6 * dt);
        p.life -= dt;
        if (p.life <= 0) particles.splice(i, 1);
      }

      // ===== æ•µäººè¿½é€ =====
      for (const en of enemies) {
        const dx = player.x - en.x;
        const dy = player.y - en.y;
        const len = Math.hypot(dx, dy) || 1;
        const nx = dx / len, ny = dy / len;

        en.wob += dt * 3.5;
        const wobx = Math.cos(en.wob) * 0.22;
        const woby = Math.sin(en.wob) * 0.22;

        en.x += (nx + wobx) * en.sp * dt;
        en.y += (ny + woby) * en.sp * dt;

        // ç¢°æ’ï¼šç©å®¶è¢«æ’
        const rr = (player.r + en.r);
        if (dist2(player.x, player.y, en.x, en.y) <= rr * rr) {
          end();
          return;
        }
      }

      // ===== è¨ˆæ™‚ & åˆ†æ•¸ =====
      timeLeft -= dt;
      if (timeLeft < 0) timeLeft = 0;

      // ç”Ÿå­˜åˆ†
      score += 10 * dt;
      // ç§»å‹•å°åŠ æˆ
      if (ix !== 0 || iy !== 0) score += 0.6 * dt;

      tEl.textContent = timeLeft.toFixed(1);
      sEl.textContent = Math.floor(score).toString();

      // ===== ç”Ÿæˆæ•µäºº =====
      spawnTimer += dt;
      if (spawnTimer >= spawnEvery) {
        spawnTimer = 0;
        spawnEnemy();
      }

      // ===== é€šé—œ =====
      if (timeLeft <= 0) {
        end("ä½ æ’åˆ°æ™‚é–“æ­¸é›¶ï¼é€šé—œ ğŸ‰");
      }
    }

    // ======= ç¹ªè£½ =======
    function draw(now) {
      ctx.clearRect(0, 0, W, H);

      // æ ¼ç·šèƒŒæ™¯
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for (let x = 0; x <= W; x += 30) { ctx.moveTo(x, 0); ctx.lineTo(x, H); }
      for (let y = 0; y <= H; y += 30) { ctx.moveTo(0, y); ctx.lineTo(W, y); }
      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.globalAlpha = 1;

      // è£é£¾åœˆ
      ctx.globalAlpha = 0.6;
      ctx.beginPath();
      ctx.arc(W*0.5, H*0.5, 110 + Math.sin((now||0)/500)*4, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(120,150,255,.18)";
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.globalAlpha = 1;

      // ç²’å­
      for (const p of particles) {
        ctx.globalAlpha = clamp(p.life * 3, 0, 1);
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255,255,255,1)";
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      // å­å½ˆ
      for (const b of bullets) {
        drawGlowCircle(b.x, b.y, b.r, "rgba(170,210,255,1)", "rgba(170,210,255,.25)");
      }

      // ç©å®¶ï¼ˆå«æ–¹å‘å°ç®­é ­ï¼‰
      drawGlowSquare(player.x, player.y, player.r, "rgba(70,255,150,1)", "rgba(70,255,150,.25)");
      drawFacing(player.x, player.y, player.dirX, player.dirY);

      // æ•µäºº
      for (const en of enemies) {
        drawGlowSquare(en.x, en.y, en.r, "rgba(255,90,90,1)", "rgba(255,90,90,.22)");
      }

      // é‚Šæ¡†
      ctx.globalAlpha = 0.8;
      ctx.strokeStyle = "rgba(255,255,255,.12)";
      ctx.lineWidth = 2;
      ctx.strokeRect(10, 10, W - 20, H - 20);
      ctx.globalAlpha = 1;
    }

    function drawGlowSquare(x, y, r, fill, glow) {
      ctx.save();
      ctx.shadowColor = glow;
      ctx.shadowBlur = 18;
      ctx.fillStyle = glow;
      ctx.fillRect(x - r - 2, y - r - 2, (r + 2) * 2, (r + 2) * 2);
      ctx.restore();

      ctx.fillStyle = fill;
      ctx.fillRect(x - r, y - r, r * 2, r * 2);

      ctx.globalAlpha = 0.35;
      ctx.fillStyle = "white";
      ctx.fillRect(x - r + 3, y - r + 3, r * 1.1, 3);
      ctx.globalAlpha = 1;
    }

    function drawGlowCircle(x, y, r, fill, glow) {
      ctx.save();
      ctx.shadowColor = glow;
      ctx.shadowBlur = 18;
      ctx.fillStyle = fill;
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    function drawFacing(x, y, dx, dy) {
      const len = Math.hypot(dx, dy) || 1;
      const nx = dx / len, ny = dy / len;
      const sx = x + nx * 18;
      const sy = y + ny * 18;

      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(sx, sy);
      ctx.strokeStyle = "rgba(200,255,220,.7)";
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(sx, sy, 3, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(200,255,220,1)";
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // åˆå§‹åŒ–
    reset(false);
  </script>
</body>
</html>
